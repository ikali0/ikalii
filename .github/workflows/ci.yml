name: Continuous Integration & Audit

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

# Cancel in-progress runs for the same workflow on the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_test_lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun Dependencies
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install

      - name: ðŸ” Run ESLint (Code Quality Audit)
        run: npm run lint
        continue-on-error: false

      - name: ðŸ”’ Run Type Check (TypeScript Audit)
        run: npx tsc --noEmit
        continue-on-error: false

      - name: ðŸ§ª Run Unit Tests (Vitest)
        run: bun test
        continue-on-error: false

      - name: ðŸ“Š Generate Job Summary
        if: always()
        run: |
          echo "## Build, Test & Lint Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Linting completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Type checking completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Unit tests completed" >> $GITHUB_STEP_SUMMARY

  e2e_testing:
    needs: build_test_lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Optimized: Run only essential browsers for faster CI
        # Full browser matrix: chromium, firefox, webkit, Mobile Chrome, Mobile Safari
        project: ['chromium', 'Mobile Chrome']

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun Dependencies
        uses: actions/cache@v4
        id: bun-cache
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright Browsers
        run: npx playwright install ${{ matrix.project }} --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Install Playwright Browser Dependencies Only
        run: npx playwright install-deps ${{ matrix.project }}
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: ðŸŒ Run E2E Tests (Playwright - ${{ matrix.project }})
        run: npx playwright test --project=${{ matrix.project }}
        continue-on-error: false

      - name: ðŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.project }}
          path: playwright-report/
          retention-days: 7

      - name: ðŸ“¤ Upload Test Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-${{ matrix.project }}
          path: test-results/
          retention-days: 7

      - name: ðŸ“Š Generate Job Summary
        if: always()
        run: |
          echo "## E2E Test Summary (${{ matrix.project }})" >> $GITHUB_STEP_SUMMARY
          echo "Browser: ${{ matrix.project }}" >> $GITHUB_STEP_SUMMARY
          if [ -f playwright-report/index.html ]; then
            echo "âœ… E2E tests completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ E2E tests failed or incomplete" >> $GITHUB_STEP_SUMMARY
          fi
